<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Resultado de Firma (Trifásica)</title>
  <meta charset="UTF-8"/>
</head>
<body>
<h1>Resultado / Firma (Trifásica)</h1>

<div th:if="${error}">
  <p style="color:red" th:text="${error}"></p>
</div>
<div th:if="${message}">
  <p style="color:green" th:text="${message}"></p>
</div>

<!-- Si tenemos 'fileId', mostramos el botón para firmar -->
<div th:if="${fileId}">
  <button onclick="invokeAutoFirma()">FIRMAR</button>
</div>

<!-- Mostramos el enlace de descarga del PDF (firmado o no),
     se descargará siempre con la misma ID, pero si ya está firmado,
     tendrás el PDF firmado. -->
<div th:if="${fileId}">
  <p>
    <a th:href="@{/sign/download(fileId=${fileId})}" download="documento-firmado.pdf">
      Descargar PDF (firmado si se ha hecho)
    </a>
  </p>
</div>

<script th:inline="javascript">
  /* <![CDATA[ */
  function invokeAutoFirma() {

    // fileId es la clave con la que guardamos el PDF
    var fileId = /*[[${fileId}]]*/ '';

    // Nombre "amigable" del archivo
    var fileName = /*[[${fileName}]]*/ 'documento-sin-firma.pdf';

    // storageServletUrl es pasado desde el controlador
    var storageServletUrl = /*[[${storageServletUrl}]]*/ '';

    // Construimos la invocación trifásica a AutoFirma.
    // IMPORTANTE: Debe ser afirma://service (NO afirma://sign)
    //   afirma://service
    //       ?operation=sign
    //       &stservlet=...
    //       &id=...
    //       &filename=...
    //       &format=pdf
    //       &algorithm=SHA512withRSA
    //       &properties=signatureSubFilter=PADES
    //
    // Nota: "op=sign" y "operation=sign" funcionan prácticamente igual;
    //       lo realmente crítico es usar "afirma://service" en vez de "afirma://sign".

    var url = "afirma://service" +
            "?operation=sign" +
            "&stservlet=" + encodeURIComponent(storageServletUrl) +
            "&id=" + encodeURIComponent(fileId) +
            "&filename=" + encodeURIComponent(fileName) +
            "&format=pdf" +
            "&algorithm=SHA512withRSA" +
            "&properties=" + encodeURIComponent("signatureSubFilter=PADES");

    console.log("Invocando AutoFirma (trifásica) con URL: " + url);
    window.location = url;
  }
  /* ]]> */
</script>

</body>
</html>
